# ClosetWeek 実装指針（MVP初期フェーズ再整理）

本書は、現行コードベース（Swift Package構成）を前提に、次フェーズで迷わず実装を進めるための実装指針です。  
対象は iOS 17+ / SwiftUI / SwiftData を想定し、当面は「画面骨組み＋遷移＋同期」の堅牢化を優先します。

## 1. 開発方針
- UI文言は日本語を基本とする
- 依存はApple標準を優先し、外部ライブラリ追加は必要性を明確化してから行う
- 画面遷移は **Coordinator経由のみ**（Viewから直接Path操作しない）
- 状態同期は `WeekPlanStore` を単一情報源（Single Source of Truth）として扱う
- ドメイン境界（Repository / UseCase）を維持し、実装差し替え可能性を担保する

## 2. 現在の構成（維持すべき責務）
- `Shared/Navigation/Routes.swift`
  - `MainTab`, `WeekRoute`, `ClosetRoute`, `SuggestionRoute` を定義
- `Shared/Navigation/Coordinators.swift`
  - `MainTabCoordinator` が各機能Coordinatorと `WeekPlanStore` を保持
- `Shared/Store/WeekPlanStore.swift`
  - `plansById`, `upsert`, `plan(id:)`, `observe/removeObserver`
- `Domain/`
  - Repository / UseCase のプロトコル群
- `Data/`
  - InMemory Repository, Stub UseCase
- `Features/*`
  - View / ViewModel（State/Event中心）

## 3. 実装ルール（必須）

### 3.1 ナビゲーション
- 新規遷移追加時は必ず以下の順で更新する
  1. `Routes.swift` にケース追加
  2. 対応するCoordinatorに `push/pop` 利用箇所を追加
  3. 該当Viewの `navigationDestination` に分岐を追加
- 画面間データはRoute引数で受け渡し、グローバル参照を避ける

### 3.2 ViewModel
- すべてのViewModelで `State` / `Event` を分離する
- `LoadingState`（`idle/loading/success/error`）の扱いを統一する
- 外部イベント反映（Store監視など）は `init` で購読、`deinit` で必ず解除する
- エラー文言は日本語で統一し、UIで表示可能な文字列にする

### 3.3 Store同期
- `WeekPlan` の更新は `WeekPlanStore.upsert(_:)` を唯一の更新経路に寄せる
- `WeekOverviewViewModel` / `WeekDetailViewModel` は同一 `weekPlanId` の更新を購読で反映する
- 同期テストは「更新元A → 反映先B」が明確なケースで追加する

### 3.4 Data/Domain
- 新規機能の永続化/API連携は、まず `Domain` のprotocolを拡張してから `Data` 実装を追加
- Stub実装でも成功/失敗の両パスを再現可能にして、UI状態遷移のテストを可能にする

## 4. 次フェーズ推奨タスク

### フェーズA: 画面骨組みの穴埋め
- Week
  - 週詳細画面・日別編集画面を独立View化
  - AI重み設定画面（スライダーUIの最低限）を追加
- Suggestion
  - 条件入力・結果一覧・詳細を分離し、Coordinator遷移を明示
- Settings
  - 地域設定はダミーリンクから設定フォーム骨組みに昇格

### フェーズB: 永続化（SwiftData）
- `WeekPlanRepository` のSwiftData実装を追加（InMemoryはテスト専用として残す）
- アプリ起動時ロード/保存時更新をUseCaseで統一
- マイグレーションを見据えたModel設計（ID, 作成更新日時）を導入

### フェーズC: 外部連携準備
- Weather/SuggestionのRepository実装をHTTPクライアント前提で差し替え
- API失敗時のリトライ方針とUIメッセージを定義

## 5. テスト方針
- 最低限維持するテストカテゴリ
  - Coordinator: タブ履歴・push/pop・Route引数整合
  - Store: upsert更新・購読通知
  - ViewModel: 成功/失敗/同期反映
  - Repository: InMemory整合
- テスト命名は「日本語 + 期待結果」で可読性優先
- 追加機能ごとに「失敗時に遷移しない」ケースを1件以上追加

## 6. CI運用指針
- `.github/workflows/ci.yml` の `swift test` を必須ゲートとして扱う
- PRでは以下を満たすこと
  - ローカル `swift test` 緑
  - CI 緑
  - 変更理由（Why）と影響範囲（Impact）を明記

## 7. コーディング規約（簡易）
- アクセスレベルは最小化（`public` は公開I/Fのみ）
- 値オブジェクトは `struct`、参照共有が必要なもののみ `class`
- マジック文字列は可能な範囲で定数化
- 1ファイル1責務を意識し、肥大化したら分割する

---
この指針は「初期実装の手戻り防止」が目的です。  
仕様変更が入った場合は、まず本ドキュメントの該当章を更新してから実装に着手してください。
